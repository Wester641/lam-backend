name: Deploy to Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /root/app
          
          docker-compose down
          
          git pull origin main
          
          cat > .env << EOF
          DATABASE_URL=sqlite:///ecommerce.db
          APP_NAME=lnm-backend
          APP_VERSION=1.0.0
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          ALLOWED_ORIGINS=["http://localhost:3000","http://${{ secrets.SSH_HOST }}:3000"]
          UPLOAD_DIR=uploads
          MAX_FILE_SIZE=5242880
          EOF
          
          docker-compose build
          docker-compose up -d
          
          docker-compose ps