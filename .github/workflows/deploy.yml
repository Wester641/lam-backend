name: Deploy to Server Maks

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: 22
        timeout: 60s
        command_timeout: 30m
        script: |
          cd /root/app
          git pull origin main
          
          cat > .env << EOF
          # Database Configuration
          POSTGRES_USER=ecommerce_user
          POSTGRES_PASSWORD=ecommerce_password123
          POSTGRES_DB=ecommerce_db
          
          # Application Configuration
          APP_NAME=lnm-backend
          APP_VERSION=1.0.0
          DEBUG=False
          
          # Security
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          
          # CORS
          ALLOWED_ORIGINS=["http://localhost:3000","http://${{ secrets.SSH_HOST }}:3000"]
          
          # File Upload
          UPLOAD_DIR=uploads
          MAX_FILE_SIZE=5242880
          
          # Database URL
          DATABASE_URL=postgresql://ecommerce_user:ecommerce_password123@db:5432/ecommerce_db
          EOF
          
          docker compose down
          docker compose up -d --build
          
          echo "Waiting for database to be ready..."
          sleep 15
          
          docker compose exec -T db pg_isready -U ecommerce_user -d ecommerce_db
          
          docker compose exec -T api alembic upgrade head
          
          docker compose ps
          docker compose logs --tail=50
    
    - name: Wait for services
      run: sleep 30
    
    - name: Notify on Success
      if: success()
      run: |
        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.GROUP_ID }}" \
          -d "text=âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!%0AðŸ—„ï¸ PostgreSQL Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½%0AðŸš€ API Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ%0AðŸ“Š ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹" \
          -d "parse_mode=HTML"
    
    - name: Notify on Failure
      if: failure()
      run: |
        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.GROUP_ID }}" \
          -d "text=âŒ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»ÑÑ!%0AÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ GitHub Actions%0AÐ ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ github.repository }}" \
          -d "parse_mode=HTML"